package com.example.mailbuddy.controller;

import com.example.mailbuddy.dto.SummaryDto;
import com.example.mailbuddy.entity.Gmail;
import com.example.mailbuddy.entity.Summary;
import com.example.mailbuddy.entity.User;
import com.example.mailbuddy.repository.GmailRepository;
import com.example.mailbuddy.repository.SummaryRepository;
import com.example.mailbuddy.repository.UserRepository;
import com.example.mailbuddy.service.SummaryService;
import com.fasterxml.jackson.core.JsonProcessingException;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.format.annotation.DateTimeFormat;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.security.oauth2.client.authentication.OAuth2AuthenticationToken;
import org.springframework.security.oauth2.core.user.OAuth2User;
import org.springframework.web.bind.annotation.*;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.*;

@RestController
@RequestMapping("/api/summarize")
@RequiredArgsConstructor
public class SummaryController {

    private final SummaryService summaryService;
    private final UserRepository userRepository;
    private final GmailRepository gmailRepository;

    @Autowired
    private SummaryRepository summaryRepository;

    // 1개의 지메일 기본키 이용해서 요약하기 (백엔드 확인용)
    @PostMapping("/from-gmail/{gmailId}")
    public ResponseEntity<?> createFromGmail(@PathVariable Long gmailId) throws JsonProcessingException {
        SummaryDto dto = summaryService.summarizeSaveFromGmailId(gmailId);
        if (dto == null) return ResponseEntity.noContent().build();
        return ResponseEntity.ok(dto);
    }

    // 로그인한 사용자의 요약 이메일 전체 불러오기
    @GetMapping("/list")
    public ResponseEntity<?> listAll(Authentication auth) {
        if (auth == null || !auth.isAuthenticated()) {
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED)
                    .body(Map.of("error", "로그인 정보가 없습니다."));
        }

        // 사용자 조회
        User user = userRepository.findByUsername(auth.getName())
                .orElseThrow(() -> new UsernameNotFoundException("사용자 정보가 없습니다."));

        // Gmail.user.id 기준으로 요약 조회
        List<Summary> summaries = summaryRepository.findAllByGmail_User_IdOrderByCreatedAtDesc(user.getId());

        // DTO 변환
        List<SummaryDto> result = summaries.stream().map(SummaryDto::from).toList();

        return ResponseEntity.ok(result);
    }

    @PostMapping("/summarize-existing")
    public ResponseEntity<List<SummaryDto>> summarizeExisting(OAuth2AuthenticationToken authentication) {
        OAuth2User oauth = authentication.getPrincipal();
        String googleEmail = oauth.getAttribute("email");
        User loginUser = userRepository.findByGoogleEmail(googleEmail)
                .orElseThrow(() -> new UsernameNotFoundException("User not found"));

        List<Gmail> mails = gmailRepository.findByUser(loginUser);

        List<SummaryDto> results = new ArrayList<>();
        for (Gmail g : mails) {
            SummaryDto dto = summaryService.summarizeSaveFromGmailId(g.getId());
            if (dto != null) results.add(dto);
        }
        return ResponseEntity.ok(results);
    }

    @GetMapping("/getSummaryDate")
    public ResponseEntity<?> getSummariesByDate(
            @RequestParam("value") @DateTimeFormat(pattern = "yyyy-MM-dd") LocalDate day,
            Authentication auth) {
        if (auth == null || !auth.isAuthenticated()) {
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED)
                    .body(Map.of("error", "로그인 정보가 없습니다."));
        }

        User user = userRepository.findByUsername(auth.getName())
                .orElseThrow(() -> new UsernameNotFoundException("사용자 정보가 없습니다."));

        LocalDateTime start = day.atStartOfDay();
        LocalDateTime end = start.plusDays(1);

        List<Summary> schedules = summaryRepository
                .findAllByGmail_User_IdAndEventTimeBetweenOrderByEventTimeAsc(user.getId(), start, end);

        return ResponseEntity.ok(schedules);
    }

    @GetMapping("/{id}")
    public ResponseEntity<?> getOne(@PathVariable("id") Long id, Authentication auth) {
        Optional<Summary> opt = summaryRepository.findById(id);
        if (opt.isEmpty())
            return ResponseEntity.status(HttpStatus.NOT_FOUND)
                    .body(Map.of("error", "없는 글입니다."));
        if (auth == null || !auth.isAuthenticated())
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED)
                    .body(Map.of("error", "로그인 정보가 없습니다."));

        Summary s = opt.get();
        if (!auth.getName().equals(s.getGmail().getUser().getUsername())) {
            return ResponseEntity.status(HttpStatus.FORBIDDEN)
                    .body(Map.of("error", "권한이 없습니다."));
        }
        return ResponseEntity.ok(s);
    }

    @PutMapping("/{id}")
    public ResponseEntity<?> updateSummary(
            @PathVariable Long id,
            @RequestBody SummaryDto dto,
            Authentication auth
    ) {
        Optional<Summary> opt = summaryRepository.findById(id);
        if (opt.isEmpty())
            return ResponseEntity.status(HttpStatus.NOT_FOUND)
                    .body(Map.of("error", "없는 요약입니다."));

        if (auth == null || !auth.isAuthenticated()) {
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED)
                    .body(Map.of("error", "로그인 정보가 없습니다."));
        }

        Summary s = opt.get();
        if (!auth.getName().equals(s.getGmail().getUser().getUsername())) {
            return ResponseEntity.status(HttpStatus.FORBIDDEN)
                    .body(Map.of("error", "권한이 없습니다."));
        }

        s.setTitle(dto.getTitle());
        s.setPlace(dto.getPlace());
        s.setNotes(dto.getNotes());
        s.setSenderName(dto.getName());
        s.setSenderEmail(dto.getEmail());

        try {
            if (dto.getTime() != null) {
                s.setEventTime(LocalDateTime.parse(dto.getTime()));
            }
        } catch (Exception e) {
            System.err.println("시간 파싱 실패: " + dto.getTime());
        }

        summaryRepository.save(s);
        return ResponseEntity.ok(SummaryDto.from(s));
    }

    @DeleteMapping("/{id}")
    public ResponseEntity<?> delete(@PathVariable Long id, Authentication auth) {
        Optional<Summary> opt = summaryRepository.findById(id);
        if (opt.isEmpty())
            return ResponseEntity.status(HttpStatus.NOT_FOUND)
                    .body(Map.of("error", "없는 글입니다."));
        if (auth == null || !auth.isAuthenticated())
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED)
                    .body(Map.of("error", "로그인 정보가 없습니다."));

        Summary s = opt.get();
        if (!auth.getName().equals(s.getGmail().getUser().getUsername())) {
            return ResponseEntity.status(HttpStatus.FORBIDDEN)
                    .body(Map.of("error", "권한이 없습니다."));
        }

        summaryRepository.delete(s);
        return ResponseEntity.ok(Map.of("message", "삭제가 완료되었습니다."));
    }
}